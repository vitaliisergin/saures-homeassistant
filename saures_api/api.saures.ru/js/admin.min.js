$(function() {
    "use strict";
    $(function() {
        $(".preloader").fadeOut()
    }),
    jQuery(document).on("click", ".mega-dropdown", function(i) {
        i.stopPropagation()
    });
    var i = function() {
        var i = window.innerWidth > 0 ? window.innerWidth : this.screen.width
          , e = 70;
        1170 > i ? ($("body").addClass("mini-sidebar"),
        $(".navbar-brand span").hide(),
        $(".scroll-sidebar, .slimScrollDiv").css("overflow-x", "visible").parent().css("overflow", "visible"),
        $(".sidebartoggler i").addClass("ti-menu")) : ($("body").removeClass("mini-sidebar"),
        $(".navbar-brand span").show());
        var o = (window.innerHeight > 0 ? window.innerHeight : this.screen.height) - 1;
        o -= e,
        1 > o && (o = 1),
        o > e && $(".page-wrapper").css("min-height", o + "px")
    };
    $(window).ready(i),
    $(window).on("resize", i),
    $(".sidebartoggler").on("click", function() {
        $("body").hasClass("mini-sidebar") ? ($("body").trigger("resize"),
        $(".scroll-sidebar, .slimScrollDiv").css("overflow", "hidden").parent().css("overflow", "visible"),
        $("body").removeClass("mini-sidebar"),
        $(".navbar-brand span").show()) : ($("body").trigger("resize"),
        $(".scroll-sidebar, .slimScrollDiv").css("overflow-x", "visible").parent().css("overflow", "visible"),
        $("body").addClass("mini-sidebar"),
        $(".navbar-brand span").hide())
    }),
    $(".fix-header .topbar").stick_in_parent({}),
    $(".nav-toggler").click(function() {
        $("body").toggleClass("show-sidebar"),
        $(".nav-toggler i").toggleClass("ti-menu"),
        $(".nav-toggler i").addClass("ti-close")
    }),
    
    $(".search-box a, .search-box .app-search .srh-btn").on("click", function() {
        $(".app-search").toggle(200);
        $(".search-box > form > input").focus();
    }),
    $(".search-box > form > input").on("input", function(e) {
        var val = e.target.value.trim();
        var unique_symbols = new Set(val.replace(/[0-9<>()[\]\.,;:/\\!#*&^%$@_+='"{}|-]/g, '').split(""));
        const sn_reg = /^([0-9]{6,8})$|^([a-fA-F0-9]{12})$/;
        const phone_reg = /^[+]?[0-9\(\)\-\s]{7,30}$/;
        const email_reg = /^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
        const other_reg = /^([0-9]{10})$/;
        if (unique_symbols.size >= 5 | sn_reg.test(val) | other_reg.test(val) | phone_reg.test(val) | email_reg.test(val)) {
            console.log(val)
        }
    }),
    $(".search-box > form").on("submit", function(e) {
        e.preventDefault();
        var val = $(e.target)[0][0].value.trim();
        const sn_reg = /^([0-9]{6,8})$|^([a-fA-F0-9]{12})$/;
        const phone_reg = /^[+]?[0-9\(\)\-\s]{7,30}$/;
        const email_reg = /^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
        if (sn_reg.test(val)) {
            window.location.replace('/sensors/?sensor=' + val)
        } else if (email_reg.test(val) | phone_reg.test(val)) {
            window.location.replace('/users/role/0?srch=' + encodeURIComponent(val))
        } else {
            window.location.replace('/company/addresses?srch=' + encodeURIComponent(val))
        }
    }),
    $(".right-side-toggle").click(function() {
        $(".right-sidebar").slideDown(50),
        $(".right-sidebar").toggleClass("shw-rside")
    }),
    $(".floating-labels .form-control").on("focus blur", function(i) {
        $(this).parents(".form-group").toggleClass("focused", "focus" === i.type || this.value.length > 0)
    }).trigger("blur"),
    $(function() {
        for (var i = window.location, e = $("ul#sidebarnav a").filter(function() {
            return this.href == i
        }).addClass("active").parent().addClass("active"); ; ) {
            if (!e.is("li"))
                break;
            e = e.parent().addClass("in").parent().addClass("active")
        }
    }),
    $(function() {
        $('[data-toggle="tooltip"]').tooltip()
    }),
    $(function() {
        $('[data-toggle="popover"]').popover()
    }),
    $(function() {
        $("#sidebarnav").metisMenu()
    }),
    $(".scroll-sidebar").slimScroll({
        position: "left",
        size: "5px",
        height: "100%",
        color: "#dcdcdc"
    }),
    $(".message-center").slimScroll({
        position: "right",
        size: "5px",
        color: "#dcdcdc"
    }),
    $(".aboutscroll").slimScroll({
        position: "right",
        size: "5px",
        height: "80",
        color: "#dcdcdc"
    }),
    $(".message-scroll").slimScroll({
        position: "right",
        size: "5px",
        height: "570",
        color: "#dcdcdc"
    }),
    $(".chat-box").slimScroll({
        position: "right",
        size: "5px",
        height: "470",
        color: "#dcdcdc"
    }),
    $(".slimscrollright").slimScroll({
        height: "100%",
        position: "right",
        size: "5px",
        color: "#dcdcdc"
    }),
    $("body").trigger("resize"),
    $(".list-task li label").click(function() {
        $(this).toggleClass("task-done")
    }),
    $("#to-recover").on("click", function() {
        $("#loginform").slideUp(),
        $("#recoverform").fadeIn()
    }),
    $('a[data-action="collapse"]').on("click", function(i) {
        i.preventDefault(),
        $(this).closest(".card").find('[data-action="collapse"] i').toggleClass("ti-minus ti-plus"),
        $(this).closest(".card").children(".card-body").collapse("toggle")
    }),
    $('a[data-action="expand"]').on("click", function(i) {
        i.preventDefault(),
        $(this).closest(".card").find('[data-action="expand"] i').toggleClass("mdi-arrow-expand mdi-arrow-compress"),
        $(this).closest(".card").toggleClass("card-fullscreen")
    }),
    $('a[data-action="close"]').on("click", function() {
        $(this).closest(".card").removeClass().slideUp("fast")
    })
});

$('.delete-stuff').on('click', function() {
    var t = $(this).data('title')
      , url = $(this).data('url');
    if (confirm(t + ' ?')) {
        window.location = url;
    }
});
$('.delete-action').on('click', function() {
    var t = $(this).data('title');
    url = $(this).data('url');
    action_id = $(this).data('id');
    if (confirm(t + ' ?')) {
        $.post(
            url,
            {action_id: action_id},
            function(data) {
                if (data=='ok') {
                    window.location.reload(false);
                } else {
                    console.log('error');
                }
            }
        );
    }
});
$('.delete-key').on('click', function() {
    var t = $(this).data('title')
      , url = $(this).data('url');
    if (confirm(t + ' ?')) {
        window.location = url;
    }
});
$('#js__refreshButtonByFilter').click(function(el) {
    $('form').attr('action', 'edit-filtered-sensors').submit();
});
$('#js__exportButtonByFilter').click(function(el) {
    setTimeout(function() {
        $('form').attr('action', '')
    }, 1000);
    $('form').attr('action', 'export-filtered-sensors').submit();
});

function generateRandomPassword(length) {
    var chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOP1234567890";
    var pass = "";
    for (var x = 0; x < length; x++) {
        var i = Math.floor(Math.random() * chars.length);
        pass += chars.charAt(i);
    }
    document.getElementById('new_password').value = pass
}

const b64toBlob = (b64Data,contentType='',sliceSize=512)=>{
    const byteCharacters = atob(b64Data);
    const byteArrays = [];

    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);

        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }

        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }

    const blob = new Blob(byteArrays,{
        type: contentType
    });
    return blob;
}

function showMessage(message) {
    console.log(message);

    var data = jQuery.parseJSON(message.data);
    if (data.error) {
        console.log(data.error)
        $('#waitModal').modal('hide');
        $.toast({
            heading: 'Ошибка',
            text: data.error,
            position: 'top-right',
            loaderBg: '#ff6849',
            icon: 'error',
            hideAfter: 3500
        });
    }
    if (data.file) {
    	$('#waitModal').modal('hide');
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        const blob = b64toBlob(data.file.b64, data.file.mime);
        url = window.URL.createObjectURL(blob);
        a.href = url;
        a.download = data.file.name;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    if (data.save) {
        var d = window.Chart_queue.data.datasets[0].data;
        d = d.filter(function(value, index, arr) {
            return !Object.keys(data.save.queue).includes(value['x'])
        });
        Object.keys(data.save.queue).forEach(function(key) {
            d.push({
                "x": key,
                "y": data.save.queue[key]
            });
        });
        d.sort(function(a, b) {
            a_dt = moment(a['x']);
            b_dt = moment(b['x']);
            return a_dt - b_dt;
        });
        window.Chart_queue.data.datasets[0].data = d.slice(Math.max(d.length - 300, 1));
        window.Chart_queue.update();
        if (data.save.in_process) {
            $in_process = $('#in_process');
            if (data.save.in_process.length > 0) {
                $in_process.text('В обработке: ');
                data.save.in_process.forEach(function(sn) {
                    $in_process.append("<a href='/sensors/?sensor=" + sn + "'><span class='label label-light-info mb-2'>" + sn + "</span></a> ");
                });
            } else {
                $in_process.empty();
            }
        }

    }
    if (data.send) {
        data.send.forEach(function (t, i) {

            var d = window.Chart_send_queue.data.datasets[i].data;
            d = d.filter(function(value, index, arr) {
                var dates = [];
                for (var i = 0; i < t.length; i++) {
                    dates.push(t[i].datetime)
                };
                return !dates.includes(value['x'])
            });
            t.forEach(function(point) {
                d.push({
                    "x": point.datetime,
                    "y": point.value
                });
            });
            d.sort(function(a, b) {
                a_dt = moment(a['x']);
                b_dt = moment(b['x']);
                return a_dt - b_dt;
            });

        window.Chart_send_queue.data.datasets[i].data = d;
        });
        window.Chart_send_queue.update();
    } 
    if (data.dashboard) {
        $('#dashboard').html(data.dashboard);
    }
}

var ws_timeout = 3000;
function prepare_ws(url) {
    var ws = new WebSocket(url);
    ws.onopen = function(event) {
        console.log(event);
        if (window.location.pathname == '/dashboard') {
            ws.send('/dashboard' + window.location.search);
        };
        $('button[data-ws]').each(function(i) {$(this).prop('disabled', false);});
        ws_timeout = 3000;
        console.log('Connection to server started');
    };
    ws.onclose = function(event) {
        console.log(event);
        $('#waitModal').modal('hide');
        //$('button[data-ws]').each(function(i) {$(this).prop('disabled', true);});
        if (event.wasClean) {
            console.log('Clean connection end');
        } else {
            console.log('Connection broken');
            ws_timeout += 2000;
            if (ws_timeout < 20000) {
            setTimeout(function() {
            	prepare_ws(url);
            }, ws_timeout);}
        }
        //clearInterval(QtimerId);
    };
    ws.onerror = function(error) {
        console.log(error);
        ws.close();
    };
    ws.onmessage = showMessage;
    return ws
}
