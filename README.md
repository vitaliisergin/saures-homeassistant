# Saures Home Assistant Integration

Интеграция для Home Assistant для мониторинга показаний счётчиков воды через систему Saures.

## Описание

Кастомная интеграция для Home Assistant, которая позволяет получать данные с контроллеров Saures (модель R1) и отображать показания счётчиков холодной и горячей воды, а также диагностическую информацию о состоянии контроллеров.

## Возможности

- Показания счётчиков холодной и горячей воды в реальном времени
- Диагностика контроллеров (заряд батареи, уровень сигнала, состояние связи)
- Автоматический импорт исторических данных (последние 7 дней при первой настройке, затем ежедневное обновление)
- Совместимость с Energy Dashboard в Home Assistant
- Поддержка Home Assistant 2025.10+ (включая новые требования к API статистики)
- Настраиваемый интервал обновления (минимум 60 минут для предотвращения блокировки API)
- Встроенное кеширование и обработка ошибок
- Автоматическое управление сессиями (SID) согласно документации Saures API

## Требования

- Home Assistant 2024.1.0 или новее (рекомендуется 2025.10+)
- Активный аккаунт в личном кабинете Saures
- Контроллер Saures R1 с настроенными счётчиками воды

## Установка

### Способ 1: Через HACS (рекомендуется)

1. Откройте HACS в Home Assistant
2. Перейдите в раздел "Интеграции"
3. Нажмите на три точки в правом верхнем углу и выберите "Пользовательские репозитории"
4. Добавьте URL репозитория: `https://github.com/vitaliisergin/saures-homeassistant`
5. Выберите категорию "Integration"
6. Найдите "Saures Home" в списке и установите
7. Перезагрузите Home Assistant

### Способ 2: Вручную

1. Скачайте последнюю версию из раздела Releases
2. Скопируйте папку `custom_components/saures_home` в директорию `config/custom_components/` вашего Home Assistant
3. Перезагрузите Home Assistant

## Настройка

1. Перейдите в **Настройки** → **Устройства и службы** → **Добавить интеграцию**
2. Найдите и выберите **Saures Home**
3. Введите данные для входа:
   - Email (логин от личного кабинета Saures)
   - Пароль
   - Интервал обновления (60–1440 минут, по умолчанию 60 минут)
4. Нажмите **Отправить**

После успешной настройки интеграция автоматически создаст устройства для каждого контроллера и сенсоры для всех подключённых счётчиков.

## Создаваемые сенсоры

Для каждого контроллера создаются следующие сенсоры:

### Счётчики воды
- Показания счётчика ХВС (холодная вода)
- Показания счётчика ГВС (горячая вода)
- С атрибутами: серийный номер, состояние, номер входа

### Диагностика контроллера
- Заряд батареи (%)
- Уровень сигнала RSSI (дБм)
- Время последнего подключения
- Время последнего запроса данных
- Время последнего снятия показаний
- Статус API (healthy/warning/critical)

### Статистика

Интеграция автоматически импортирует исторические данные показаний счётчиков:
- При первой настройке: последние 7 дней
- Затем: ежедневное обновление новых данных
- Данные доступны в разделе **Developer Tools** → **Statistics**
- Совместимы с **Energy Dashboard**

## Рекомендуемые настройки

### Интервал обновления

Минимальный интервал обновления — **60 минут** (1 час). Это ограничение установлено для предотвращения блокировки вашего IP-адреса API Saures из-за слишком частых запросов.

Рекомендуемые значения:
- **60 минут** — стандартный режим (рекомендуется)
- **120 минут** — для снижения нагрузки на API
- **1440 минут** (24 часа) — минимальная нагрузка

### Использование в Energy Dashboard

1. Перейдите в **Настройки** → **Панели управления** → **Energy**
2. В разделе "Потребление воды" нажмите **Добавить источник воды**
3. Выберите нужные счётчики (ХВС и/или ГВС)
4. Сохраните настройки

После этого данные о потреблении воды будут отображаться в Energy Dashboard с возможностью просмотра статистики по дням, неделям и месяцам.

## Решение проблем

### Ошибка "Invalid Auth"
- Проверьте правильность логина и пароля
- Убедитесь, что аккаунт активен в личном кабинете Saures

### Ошибка "Connection reset by peer"
- Временная проблема с API Saures или сетью
- Интеграция автоматически повторит запрос через указанный интервал
- Если проблема постоянная — увеличьте интервал обновления до 120 минут

### Устройства не появляются при первой настройке
- Дождитесь завершения первой загрузки данных (может занять 1-2 минуты)
- Если устройства не появились — перезагрузите интеграцию через меню (три точки → Перезагрузить)

### Статистика не импортируется
- Проверьте логи на наличие ошибок
- Убедитесь, что используете Home Assistant 2024.1+
- Проверьте наличие статистики в **Developer Tools** → **Statistics** (поиск по `saures_home:`)

## Техническая информация

### API
Интеграция использует официальный Saures API v1.0:
- Базовый URL: `https://api.saures.ru/1.0`
- Документация: `https://api.saures.ru/doc/`

### Кеширование
- Встроенный LRU-кеш для снижения нагрузки на API
- Автоматическое управление временем жизни кеша
- TTL оптимизирован под интервал обновления

### Обработка ошибок
- Автоматический retry при временных ошибках
- Интеллектуальное управление SID (session ID)
- Защита от rate limiting и блокировок IP

## Поддержка и обратная связь

- **Вопросы и обсуждения**: [GitHub Discussions](https://github.com/vitaliisergin/saures-homeassistant/discussions)
- **Сообщить об ошибке**: [GitHub Issues](https://github.com/vitaliisergin/saures-homeassistant/issues)
- **Исходный код**: [GitHub Repository](https://github.com/vitaliisergin/saures-homeassistant)

## Лицензия

MIT License - см. файл [LICENSE](LICENSE)

## Благодарности

Интеграция разработана для использования с системой мониторинга Saures (https://saures.ru/)
